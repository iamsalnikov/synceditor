# Введение [Черновик]

В этом документе описаны основные принципы работы микросервиса.

**Проблемы, которые нужно решить**

- [ ] Как давать доступ приложениям
- [ ] Как давать доступ пользователям (сейчас это делается с помощью ключа)
- [ ] Какие у нас пользователи (глобальные, или пользователи документа)
- [ ] Как разруливать права (кто может добавлять документы, пользователей к документу)

## 1. Описание

Микросервис `synceditor` решает задачу параллельного редактирования данных. Такие данные называются здесь `документы`. Каждый документ состоит из блоков данных. В каждый момент времени только один пользователь может редактировать конкретный блок.

## 2. Определения

- Документ - сущность, которую может редактировать несколько пользователей одновременно, например, статья
- Блок данных - это сами данные документа. Например, возьмем такой документ:

```php
[
	'title' => 'Самая лучшая статья',
	'description' => 'Статья о статье, которая была признана самой лучшей',
	'tags' => [
		'статья',
		'рейтинг',
		'лучшее'
	]
]
```

Здесь блоки данных - это значения полей `title`, `description`, `tags`. Блоки данных могут быть вложенными. Конечным значением блока данных должен быть скаляр. Так, блок данных `tags` включает в себя еще три блока данных.

- Пользователь - пользователь документа, который имеет право на чтение и запись. У каждого пользователя документа есть свой ключ, по которому он может открыть `websocket` соединение для редактирования
- Клиент - серверное приложение, которое создает документы, добавляет новых пользователей, забирает данные
- Редактор - сущность, которая занимается редактированием документа
- Сервис - микросервис `synceditor`

## 3. Моменты, на которые стоит обратить внимание

1. Добавлять пользователей к документу может только тот, у кого есть на это право (по-умолчанию - создатель документа)
2. Поддержка `REST` и `websocket`-итерфейсов
3. Сервис не занимается сохранением. Но клиент может взять данные в любой момент
4. Клиент может получить как документ, так и снэпшот

## 4. Что должен уметь сервис

1. Принимать документ от клиента
2. Добавлять пользователя к документу
3. Удалять пользователя из документа
4. Добавлять права пользователю
5. Отдавать документ
6. Отдавать снэпшон
7. Принимать изменения и отправлять всем редакторам документа уведомления
8. Отдавать список ативных пользователей
9. Рассылать кастомные уведмления пользователям документа
10. Хранить старую версию блока данных
11. Уметь отдавать как старую версию блока данных, так и свежую
12. Блокировать блоки и не давать их редактировать никому, кроме автора блокировки
13. При отключении пользователя снимать блокировку с заблокированных им блоков
14. Удалять документ (только создатель)

При запуске сервиса ему можно передать ключ, без которого редакторы и клиенты даже не смогут подключиться к нему. По-умолчанию такого ключа не будет, что означает возможность подключения к сервису любого желающего.

## 5. Схема работы и получение данных

![](/doc/images/editor-client-service.png)

1. Редактор просит клиента дать ему ключ для доступа к документу
2. Клиент спрашивает сервис, есть ли у него снэпшот документа. Если нет, то кладет его туда, на что сервис ему отвечает о том, с каким результатом завершилось добавление.
3. Клиент добавляет пользователя к этим данным (при этом он может просто скинуть пустой запрос, либо послать вместе с запросом данные пользователя в произвольном виде (эти данные будут метаданными соединения пользователя)). Сервис отдает ключ, используя который редактор сможет установить `websocket`-соединение с сервисом.
4. Клиент отдает редактору ключ для доступа
5. Клиент устанавливает `websocket`-соединение с сервером

После подключения редактор может получить снэпшот, документ, список активных редакторов, инициировать и принимать события.